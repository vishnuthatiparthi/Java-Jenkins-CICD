pipeline {
  agent any

  parameters {
    string(name: "App_Version", description: "provide application version")
  }

  environment {
    DOCKERHUB_CREDENTIALS = credentials("dockerhub")
  }

  stages {

    stage("Repo Clone") {
      steps {
<<<<<<< HEAD
        checkout scmGit(branches: [[name: '*/master']], extensions: [], userRemoteConfigs: [[url: 'https://github.com/vishnuthatiparthi/Java-Jenkins-CICD.git']])
=======
        checkout scmGit(
          branches: [[name: '*/master']],
          extensions: [],
          userRemoteConfigs: [[url: 'https://github.com/vishnuthatiparthi/DataStore.git']]
        )
>>>>>>> d5fd54f (jenkins)
      }
    }

    stage("Maven Build") {
      steps {
        sh """
            echo "-------- Building Application --------"
            mvn clean package -DskipTests
            echo "------- Application Built Successfully --------"
        """
      }
    }

    stage("SonarQube Analysis") {
      steps {
        withSonarQubeEnv('sonar') {
          sh """
            echo "-------- Running SonarQube Scan --------"
            mvn sonar:sonar \
            -Dsonar.projectKey=datastore \
            -Dsonar.projectName=datastore \
            -Dsonar.sources=src \
            -Dsonar.java.binaries=target
          """
        }
      }
    }

    stage("SonarQube Quality Gate") {
      steps {
        timeout(time: 2, unit: 'MINUTES') {
          waitForQualityGate abortPipeline: true
        }
      }
    }

    stage("Maven Test") {
      steps {
        sh """
          echo "-------- Executing Testcases --------"
          mvn test
          echo "-------- Testcases Execution Complete --------"
        """
      }
    }

    stage("Artifact Store") {
      steps {
        sh """
          echo "-------- Pushing Artifacts To S3 --------"
          aws s3 cp ./target/*.jar s3://datastore-artefact-store-apps/
          echo "-------- Pushing Artifacts To S3 Completed --------"
        """
      }
    }

    stage("Docker Image Build") {
      steps {
        sh """
          echo "-------- Building Docker Image --------"
          docker build -t datastore:"${App_Version}" .
          echo "-------- Image Successfully Built --------"
        """
      }
    }

    stage("Docker Image Scan") {
      steps {
        sh """
          echo "-------- Scanning Docker Image --------"
          trivy image datastore:"${App_Version}"
          echo "-------- Scanning Docker Image Complete --------"
        """
      }
    }

    stage("Docker Image Tag") {
      steps {
        sh """
          echo "-------- Tagging Docker Image --------"
<<<<<<< HEAD
          docker tag datastore:"${App_Version}" vishnu898/datastore:"${App_Version}"
          echo "-------- Tagging Docker Image Completed."
=======
          docker tag datastore:"${App_Version}" 8072388539/datastore:"${App_Version}"
          echo "-------- Tagging Docker Image Completed --------"
>>>>>>> d5fd54f (jenkins)
        """
      }
    }

    stage("Login & Push Docker image") {
      steps {
        sh """
          echo "-------- Logging To DockerHub --------"
          docker login -u $DOCKERHUB_CREDENTIALS_USR --password $DOCKERHUB_CREDENTIALS_PSW
          echo "-------- DockerHub Login Successful --------"

          echo "-------- Pushing Docker Image To DockerHub --------"
          docker push vishnu898/datastore:"${App_Version}"
          echo "-------- Docker Image Pushed Successfully --------"
        """
      }
    }

    stage("Cleanup") {
      steps {
        sh """
           echo "-------- Cleaning Up Jenkins Machine --------"
           docker image prune -a -f
           echo "-------- Clean Up Successful --------"
        """
      }
    }

    stage("Deployment Acceptance") {
      steps {
        input 'Trigger Down Stream Job'
      }
    }
    stage("Triggering Deployment Job") {
      steps {
        build job: "datastore-Kubernetes", parameters: [string(name: "App_Name", value: "datastore-deploy"), string(name: "App_Version", value: "${params.App_Version}")]
      }
    }
  }
  post {
        success {
            slackSend channel: '#alerting',
                      color: 'good',
                      message: "✔️ SUCCESS: `${env.JOB_NAME} #${env.BUILD_NUMBER}` completed successfully."
        }

        failure {
            slackSend channel: '#alerting',
                      color: 'danger',
                      message: "❌ FAILURE: `${env.JOB_NAME} #${env.BUILD_NUMBER}` failed.\nCheck console output: ${env.BUILD_URL}"
        }

        unstable {
            slackSend channel: '#alerting',
                      color: 'warning',
                      message: "⚠️ UNSTABLE: `${env.JOB_NAME} #${env.BUILD_NUMBER}` returned unstable status."
        }

        aborted {
            slackSend channel: '#alerting',
                      color: '#808080',
                      message: "⛔ ABORTED: `${env.JOB_NAME} #${env.BUILD_NUMBER}` was aborted."
        }

        always {
            slackSend channel: '#alerting',
                      color: '#439FE0',
                      message: "ℹ️ Build finished: `${env.JOB_NAME} #${env.BUILD_NUMBER}`"
        }
    }
}
